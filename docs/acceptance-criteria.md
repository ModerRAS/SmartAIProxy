# SmartAIProxy .NET 9 验收标准

## 1. API 网关验收标准

### AC-01. 请求路由功能
**描述**: 验证系统可以正确将AI请求路由到适当的提供商

**标准:**
- ✅ 请求到 `/v1/chat/completions` 正确转发到选定的AI提供商
- ✅ 响应内容原样返回给客户端，不修改任何内容
- ✅ 请求头、查询参数和请求体内容完全保留
- ✅ AI提供商的错误响应正确转发给客户端
- ✅ 支持流式响应（streaming responses）
- ✅ HTTP状态码正确映射

**测试场景:**
1. 发送OpenAI格式的聊天完成请求到 `/v1/chat/completions`
2. 验证请求被正确转发到配置的OpenAI通道
3. 验证响应内容和状态码与OpenAI原始响应一致

### AC-02. 免费通道优先功能
**描述**: 验证系统优先使用免费的API通道

**标准:**
- ✅ 系统优先选择 price_per_token = 0 的通道
- ✅ 当免费通道可用时，不使用付费通道
- ✅ 免费通道的使用配额正确跟踪和限制
- ✅ 免费配额用完后自动切换到付费通道
- ✅ 通道状态（活跃/非活跃）正确影响路由决策

**测试场景:**
1. 配置一个免费通道和一个付费通道
2. 发送请求验证使用了免费通道
3. 耗尽免费配额后验证切换到付费通道

### AC-03. 折扣规则应用
**描述**: 验证时间段折扣规则正确应用

**标准:**
- ✅ 时间段路由规则正确评估和执行
- ✅ 特殊折扣时间段（如 00:00-06:00）被正确识别
- ✅ 折扣期间正确应用降低的价格
- ✅ 折扣期结束后恢复正常定价
- ✅ 多个折扣时间段的优先级正确处理

**测试场景:**
1. 配置包含折扣时间段的通道
2. 在折扣时间段内发送请求验证折扣价格应用
3. 在非折扣时间段发送请求验证正常价格

## 2. 管理API验收标准

### AC-04. 通道配置管理
**描述**: 验证通过API管理AI服务通道的功能

**标准:**
- ✅ GET `/api/channels` 返回所有配置的通道
- ✅ POST `/api/channels` 成功添加或更新通道配置
- ✅ 通道配置包含：类型、端点、API密钥、价格、配额等
- ✅ 配置更改无需服务重启立即生效
- ✅ 无效配置被拒绝并返回明确的错误信息

**测试场景:**
1. 调用GET获取当前通道列表
2. 调用POST添加新的OpenAI通道
3. 验证新通道在列表中并可正常使用

### AC-05. 路由规则管理
**描述**: 验证通过API管理路由规则的功能

**标准:**
- ✅ GET `/api/rules` 返回所有配置的路由规则
- ✅ POST `/api/rules` 成功添加或更新路由规则
- ✅ 表达式可以引用变量：day_tokens_used、channel_status等
- ✅ 规则按优先级顺序正确评估
- ✅ 无效表达式被拒绝并返回语法错误

**测试场景:**
1. 创建包含复杂表达式的路由规则
2. 验证规则按预期工作
3. 测试无效表达式的错误处理

### AC-06. 配置热更新
**描述**: 验证配置更新无需停机的功能

**标准:**
- ✅ 配置文件更改自动触发重载
- ✅ 无效配置更改被拒绝，服务继续运行
- ✅ 有效配置更改立即生效
- ✅ 配置重载期间不丢失正在处理的请求
- ✅ 配置验证机制防止服务中断

**测试场景:**
1. 修改配置文件添加新通道
2. 验证新通道立即可用，无需重启
3. 提交无效配置验证服务保持运行

## 3. 监控和运维验收标准

### AC-07. 健康检查功能
**描述**: 验证服务健康监控功能

**标准:**
- ✅ GET `/healthz` 服务健康时返回200 OK
- ✅ GET `/health` 返回管理API的详细健康状态
- ✅ Prometheus指标在 `/metrics` 端点正确暴露
- ✅ 关键指标被跟踪：请求计数、错误率、延迟
- ✅ 服务依赖项状态被正确监控

**测试场景:**
1. 访问健康检查端点验证响应
2. 停止依赖服务验证健康状态更新
3. 验证Prometheus指标端点可访问

### AC-08. 使用量和成本跟踪
**描述**: 验证API使用量和成本跟踪功能

**标准:**
- ✅ 使用量指标跟踪每个通道的请求数
- ✅ 成本计算基于配置的price_per_token
- ✅ 每个通道的配额使用正确跟踪
- ✅ 使用量报告通过指标端点可用
- ✅ 历史使用量数据被保留和查询

**测试场景:**
1. 发送多个请求到不同通道
2. 验证使用量指标正确更新
3. 验证成本计算准确

## 4. 安全验收标准

### AC-09. 网关访问安全
**描述**: 验证网关API密钥访问控制

**标准:**
- ✅ 无有效API密钥的请求被拒绝（401未授权）
- ✅ 有效API密钥被正确认证和授权
- ✅ 每个API密钥应用正确的限流
- ✅ 认证失败事件被记录
- ✅ API密钥可以被吊销和更新

**测试场景:**
1. 不提供API密钥发送请求验证401响应
2. 使用有效API密钥发送请求验证成功
3. 测试限流功能

### AC-10. 管理访问安全
**描述**: 验证管理端点的JWT认证

**标准:**
- ✅ 管理端点要求有效的JWT令牌
- ✅ JWT令牌对配置的颁发者/受众进行验证
- ✅ 过期令牌被拒绝
- ✅ 管理操作被记录用于审计
- ✅ 不同权限级别的令牌访问控制正确

**测试场景:**
1. 无JWT令牌访问管理端点验证401响应
2. 使用有效JWT令牌访问验证成功
3. 使用过期令牌验证拒绝

## 5. 可靠性验收标准

### AC-11. 通道故障处理
**描述**: 验证通道故障时的自动恢复功能

**标准:**
- ✅ 失败的请求自动以指数退避重试
- ✅ 熔断器模式防止重复失败到同一通道
- ✅ 主通道故障时使用备用通道
- ✅ 错误响应包含故障详细信息
- ✅ 故障通道恢复后自动重新加入负载均衡

**测试场景:**
1. 模拟通道故障验证重试机制
2. 验证熔断器触发和恢复
3. 测试备用通道切换

### AC-12. 高性能处理
**描述**: 验证服务在高负载下的性能表现

**标准:**
- ✅ 服务处理10,000+并发请求
- ✅ 95%的请求在100毫秒内完成
- ✅ 负载下内存使用保持稳定
- ✅ CPU利用率随请求量适当扩展
- ✅ 长时间运行不出现内存泄漏

**测试场景:**
1. 压力测试验证并发处理能力
2. 测量响应时间分布
3. 长时间运行测试验证稳定性

## 6. 开发体验验收标准

### AC-13. 本地开发便利性
**描述**: 验证本地开发环境设置

**标准:**
- ✅ 服务可通过 `dotnet run` 命令运行
- ✅ 默认配置开箱即用
- ✅ 提供示例配置文件
- ✅ 开发文档清晰说明设置过程
- ✅ 开发模式支持调试和热重载

**测试场景:**
1. 克隆项目后运行验证启动
2. 测试开发模式功能
3. 验证调试支持

### AC-14. API文档完整性
**描述**: 验证API文档的完整性和可用性

**标准:**
- ✅ OpenAPI/Swagger文档在 `/swagger` 可用
- ✅ 所有端点都有参数和响应格式文档
- ✅ 提供请求和响应示例
- ✅ 认证要求明确说明
- ✅ 文档与实际API实现保持同步

**测试场景:**
1. 访问Swagger UI验证文档展示
2. 测试文档中的示例请求
3. 验证所有端点都有文档

## 7. 集成测试验收标准

### AC-15. 端到端集成测试
**描述**: 验证完整的端到端功能

**标准:**
- ✅ 完整的请求流程测试：客户端→网关→AI提供商→客户端
- ✅ 所有主要AI提供商的集成测试
- ✅ 配置更新流程端到端测试
- ✅ 故障恢复流程测试
- ✅ 监控和数据收集测试

**测试场景:**
1. 完整的API请求端到端测试
2. 配置更新到生效的完整流程
3. 故障注入和恢复测试

### AC-16. 性能集成测试
**描述**: 验证集成环境下的性能表现

**标准:**
- ✅ 集成环境下的请求处理性能
- ✅ 多个并发用户的性能表现
- ✅ 配置重载性能影响评估
- ✅ 监控系统对性能的影响
- ✅ 网络延迟下的表现

**测试场景:**
1. 模拟生产环境的负载测试
2. 网络延迟条件下的性能测试
3. 监控启用的性能对比

## 8. 部署验收标准

### AC-17. 容器化部署
**描述**: 验证Docker容器部署

**标准:**
- ✅ 多架构Docker镜像（amd64、arm64）
- ✅ 容器健康检查支持
- ✅ 配置文件卷挂载支持
- ✅ 日志输出到stdout/stderr
- ✅ 非root用户执行
- ✅ 容器镜像安全扫描通过

**测试场景:**
1. 构建Docker镜像
2. 运行容器验证功能
3. 测试卷挂载和配置

### AC-18. Kubernetes部署
**描述**: 验证Kubernetes集群部署

**标准:**
- ✅ Kubernetes部署清单可用
- ✅ Helm chart用于简化部署
- ✅ 滚动更新策略配置
- ✅ 资源请求和限制配置
- ✅ 健康和就绪探针配置
- ✅ 服务发现集成正常

**测试场景:**
1. 在Kubernetes集群中部署
2. 测试滚动更新
3. 验证自动扩缩容

## 9. 数据迁移验收标准

### AC-19. 配置数据迁移
**描述**: 验证从Go版本的配置迁移

**标准:**
- ✅ Go版本的YAML配置兼容
- ✅ 配置数据结构正确映射
- ✅ 所有配置选项保持兼容
- ✅ 迁移后的配置功能一致
- ✅ 配置验证覆盖所有迁移场景

**测试场景:**
1. 使用Go版本配置文件启动
2. 验证所有功能正常工作
3. 测试配置更新功能

### AC-20. API兼容性
**描述**: 验证与Go版本的API兼容性

**标准:**
- ✅ 所有现有API端点保持兼容
- ✅ 请求和响应格式完全一致
- ✅ 错误响应格式保持兼容
- ✅ HTTP状态码保持一致
- ✅ 性能特征不劣于原版本

**测试场景:**
1. 使用Go版本客户端测试
2. 验证所有端点响应格式
3. 性能对比测试