# SmartAIProxy .NET 9 架构设计

## 1. 系统概述

SmartAIProxy 是一个高性能、可扩展的AI API网关服务，使用 .NET 9 和 ASP.NET Core 构建。该系统通过智能路由、成本优化、容错处理和监控统计，为开发者提供统一的AI服务接入点。

## 2. 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端应用                                     │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │ HTTP Requests
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        API网关入口 (ASP.NET Core)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────────────────┐ │
│  │ 认证中间件  │  │ 限流中间件  │  │ 预处理中间件 │  │ 错误处理中间件     │ │
│  └─────────────┘  └─────────────┘  └──────────────┘  └────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                        智能路由引擎 (Routing Engine)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────────────────┐ │
│  │ 规则引擎    │  │ 通道管理器  │  │ 配置管理器   │  │ 容错处理器         │ │
│  │ (RuleEngine)│  │(ChannelMgr) │  │ (ConfigMgr)  │  │ (FaultTolerance)   │ │
│  └─────────────┘  └─────────────┘  └──────────────┘  └────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                          AI服务提供商 (Providers)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────────────────┐ │
│  │ OpenAI      │  │ Claude      │  │ Gemini       │  │ 自定义提供商       │ │
│  └─────────────┘  └─────────────┘  └──────────────┘  └────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │ HTTP Responses
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端应用                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           管理API (Admin API)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────────────────┐ │
│  │ 认证中间件  │  │ 配置API     │  │ 通道API      │  │ 规则API            │ │
│  └─────────────┘  └─────────────┘  └──────────────┘  └────────────────────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│                        配置管理器 (ConfigManager)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          配置存储 (Config Storage)                          │
│                   (YAML/JSON files + 热重载机制)                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          监控系统 (Monitoring)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────┐  ┌────────────────────┐ │
│  │ 指标收集    │  │ 健康检查    │  │ 日志系统     │  │ Prometheus导出     │ │
│  │ (Metrics)   │  │ (Health)    │  │ (Logging)    │  │ (PrometheusExport) │ │
│  └─────────────┘  └─────────────┘  └──────────────┘  └────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心组件设计

### 3.1 ASP.NET Core 中间件管道

#### 3.1.1 网关中间件管道
```
请求入口
  ↓
认证中间件 (AuthenticationMiddleware)
  ↓
限流中间件 (RateLimitMiddleware)
  ↓
预处理中间件 (PreprocessMiddleware)
  ↓
路由中间件 (RoutingMiddleware)
  ↓
容错处理中间件 (FaultToleranceMiddleware)
  ↓
错误处理中间件 (ErrorHandlerMiddleware)
  ↓
AI提供商代理 (AIProviderProxy)
  ↓
响应返回客户端
```

#### 3.1.2 管理API中间件管道
```
管理请求入口
  ↓
JWT认证中间件 (JwtAuthenticationMiddleware)
  ↓
授权中间件 (AuthorizationMiddleware)
  ↓
请求路由到对应控制器
  ↓
配置/通道/规则管理控制器
  ↓
响应返回管理客户端
```

### 3.2 智能路由引擎

#### 3.2.1 规则引擎 (RuleEngine)
- 使用 NCalc 或自定义表达式引擎评估路由规则
- 支持复杂的数学和逻辑表达式
- 内置变量：day_tokens_used, channel_status, time_of_day 等
- 优先级排序和匹配

#### 3.2.2 通道管理器 (ChannelManager)
- 管理所有AI服务提供商的通道配置
- 跟踪使用配额和成本
- 监控通道健康状态
- 实现通道选择算法

#### 3.2.3 配置管理器 (ConfigManager)
- 加载和解析YAML/JSON配置文件
- 实现配置热重载机制
- 提供线程安全的配置访问
- 验证配置数据完整性

### 3.3 容错处理模块

#### 3.3.1 重试机制
- 指数退避算法实现
- 可配置的重试次数和间隔
- 不同错误类型的差异化处理

#### 3.3.2 熔断器模式
- 基于Polly库实现
- 自动故障检测和隔离
- 超时和超载保护

#### 3.3.3 响应验证
- 响应完整性检查
- 错误标准化处理
- 回退机制实现

### 3.4 监控系统

#### 3.4.1 指标收集
- 请求计数和成功率
- 响应延迟直方图
- 通道使用量和成本
- 系统资源使用情况

#### 3.4.2 健康检查
- 服务健康状态
- 依赖项健康检查
- 配置有效性检查

#### 3.4.3 日志系统
- 结构化日志记录
- 请求追踪ID
- 错误和异常日志
- 审计日志记录

## 4. 数据流设计

### 4.1 请求处理流程
1. 客户端发送AI API请求到网关
2. 认证中间件验证API密钥
3. 限流中间件检查请求频率
4. 预处理中间件解析和验证请求内容
5. 路由中间件使用规则引擎选择最佳通道
6. 容错处理器准备重试和熔断机制
7. 请求转发到选定的AI提供商
8. 接收响应并进行必要处理
9. 返回响应给客户端
10. 更新监控指标和日志记录

### 4.2 配置更新流程
1. 配置文件发生变化
2. 配置管理器检测到变化
3. 解析和验证新配置
4. 原子性更新配置对象
5. 通知相关组件配置已更新
6. 继续处理后续请求

### 4.3 监控数据流
1. 每个请求处理过程中收集指标
2. 指标数据存储在内存中
3. Prometheus端点定期抓取指标
4. 日志数据输出到标准输出
5. 健康检查定期更新状态

## 5. 部署架构

### 5.1 单机部署
```
┌─────────────────────────────────────────────────────────────┐
│                    负载均衡器 (可选)                        │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   SmartAIProxy实例                          │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────────┐ │
│  │ 网关服务    │  │ 管理API     │  │ 监控端点             │ │
│  └─────────────┘  └─────────────┘  └──────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    配置文件存储                         │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 集群部署
```
┌─────────────────────────────────────────────────────────────┐
│                    负载均衡器                               │
└─────────────────────────┬───────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│ 实例1       │   │ 实例2       │   │ 实例3       │
└─────────────┘   └─────────────┘   └─────────────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          ▼
              ┌───────────────────────┐
              │   共享配置存储        │
              │   (Consul/etcd等)     │
              └───────────────────────┘
```

## 6. 扩展性设计

### 6.1 水平扩展
- 无状态设计支持多实例部署
- 共享配置存储实现配置同步
- 分布式监控指标收集
- 负载均衡器分发请求

### 6.2 功能扩展
- 插件化通道提供商支持
- 自定义中间件扩展点
- 规则引擎表达式扩展
- 监控指标自定义

### 6.3 性能扩展
- 异步I/O操作优化
- 连接池和HTTP客户端复用
- 缓存机制减少重复计算
- 内存池减少GC压力

## 7. 安全设计

### 7.1 认证授权
- API密钥认证保护网关接口
- JWT认证保护管理接口
- 基于角色的访问控制(RBAC)
- 审计日志记录所有管理操作

### 7.2 数据安全
- 敏感信息加密存储
- HTTPS/TLS加密传输
- 请求/响应内容安全检查
- 防止注入攻击

### 7.3 运行时安全
- 限流防止滥用
- 熔断防止级联故障
- 超时控制防止阻塞
- 资源限制防止耗尽

## 8. 性能优化

### 8.1 .NET 9 特性利用
- 利用Native AOT减少启动时间
- 使用System.Text.Json优化序列化
- 应用HTTP/3提升传输效率
- 利用新的异步I/O优化

### 8.2 内存优化
- 对象池减少GC压力
- Span<T>减少内存分配
- 零拷贝数据处理
- 内存缓存优化访问

### 8.3 并发优化
- 异步编程模型
- 任务调度优化
- 线程池配置调优
- 锁竞争最小化